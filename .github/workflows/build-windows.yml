name: Build release for Alfa CR GUI Windows App

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Imposta MY_WORKSPACE variabile
        shell: pwsh
        run: |
          echo "MY_WORKSPACE=$env:GITHUB_WORKSPACE" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Mostra percorso MY_WORKSPACE
        shell: pwsh
        run: |
          Write-Output "Il percorso di GITHUB_WORKSPACE è $env:MY_WORKSPACE"
      
      - name: Leggi versione da pubspec.yaml
        shell: pwsh
        run: |
          $yamlPath = Join-Path $env:MY_WORKSPACE "pubspec.yaml"

          if (-Not (Test-Path $yamlPath)) {
              Write-Error "Il file pubspec.yaml non è stato trovato in $yamlPath"
              exit 1
          }

          $content = Get-Content $yamlPath -Raw

          $regex = '^\s*version\s*:\s*(.+)$'
          $match = [regex]::Match($content, $regex, [System.Text.RegularExpressions.RegexOptions]::Multiline)

          if ($match.Success) {
              $version = $match.Groups[1].Value.Trim()
              Write-Output "Versione trovata: $version"

              # (Opzionale) Imposta la versione come variabile di ambiente
              echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }
          else {
              Write-Error "La chiave 'version' non è stata trovata in pubspec.yaml"
              exit 1
          }

      - name: Utilizza la versione estratta
        shell: pwsh
        run: |
          Write-Output "La versione estratta è: $env:VERSION"

      # - name: Install Flutter
      #   uses: subosito/flutter-action@v2

      # - name: Install dependencies
      #   run: flutter pub get

      # - name: Parse pubspec.yaml
      #   uses: jonabc/read-yaml@v1
      #   id: parse_yaml
      #   with:
      #     path: pubspec.yaml
      #     key: version

      # - name: Set Version and Build Variables
      #   shell: pwsh
      #   run: |
      #     $versionParts = "${{ steps.parse_yaml.outputs.version }}" -split '\+'
      #     $version = $versionParts[0]
      #     $build = $versionParts[1]
      #     Write-Output "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      #     Write-Output "BUILD=$build" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # - name: Build Windows Release
      #   run: flutter build windows --release

      # - name: Upload Build Artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: alfa-cr-gui_v${{ env.VERSION }}_build${{ env.BUILD }}
      #     path: .\build\windows\x64\runner\Release\
